<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì ˆì•½ ì±Œë¦°ì§€ | A.P.T</title>

    <!-- External Resources -->
    <link rel="stylesheet" th:href="@{/css/font.css}" />
    <link rel="stylesheet" href="/css/sidebar_challenge.css">
    <link rel="icon" href="/icons/favicon.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        /* ===== BASE STYLES ===== */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #fdfdfd;
        }

        /* ===== LAYOUT ===== */
        .main-container {
            margin-left: 90px;
            min-height: 100vh;
            background-color: #fdfdfd;
            display: flex; /* ìì‹ ì„¹ì…˜ë“¤ì´ flex ì•„ì´í…œìœ¼ë¡œ ë°°ì¹˜ë˜ë„ë¡ */
        	flex-direction: column; /* ì„¸ë¡œë¡œ ë°°ì¹˜ */
        }

        /* ===== CHALLENGE SECTION ===== */
        .section-challenge {
            background: #fdfdfd;
            /* min-height: 100vh; */
            padding: 40px;
            width: 100%;
        }

        .left-content h2 {
            font-size: 40px;
            line-height: 1.5;
            color: #292929;
            text-align: center;
            margin-bottom: 60px;
        }

        .right-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .summary-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 640px;
            max-width: 90%;
            font-size: 25px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 20px;
            color: #292929;
        }

        .nickname {
            color: #9C6EF4;
        }

        /* ===== CATEGORY BUTTONS ===== */
        .category-buttons {
            display: flex;
            gap: 10px;
            width: 640px;
            max-width: 90%;
            justify-content: flex-start;
        }

        .category-buttons img {
            width: 140px;
            height: auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .category-buttons img:hover {
            transform: scale(1.05);
        }

        /* ===== CHALLENGE CARD ===== */
        .card {
            background: white;
            border-radius: 20px;
            padding: 40px 35px;
            width: 640px;
            max-width: 90%;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
            color: #292929;
        }

        .item:last-child {
            border-bottom: none;
        }

        .action-button img {
            width: 80px;
            height: auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .action-button img:hover {
            transform: scale(1.1);
        }

        /* ===== HISTORY SECTION ===== */
        .section-history {
            background-color: #fdfdfd;
            /* min-height: 100vh; */
            padding: 100px 40px 80px;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .section-history h2 {
            text-align: center;
            font-size: 40px;
            margin-bottom: 60px;
            line-height: 1.5;
            color: #292929;
        }

        .gray-box {
            width: 100%;
            max-width: 1200px;
            padding: 40px 30px;
            border-radius: 20px;
            display: flex;
            gap: 60px;
            justify-content: center;
            margin: 0 auto;
            min-height: 700px;
            align-items: center;
        }

        /* ===== HISTORY CARDS ===== */
        .history-card {
            flex: 1;
            min-width: 360px;
            max-width: 400px;
            height: 580px;
            border-radius: 20px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 0 25px;
            color: #ffffff;
            height: 60px;
            line-height: 60px;
            font-size: 16px;
            font-weight: bold;
        }

        .calendar-header {
            background-color: #D3BFF9;
            text-align: left;
        }

        .badge-header {
            background-color: #E7E0FF;
            color: #8B7EF1;
            text-align: left;
        }

        .point-header {
            background-color: #F1E7FC;
            color: #C4A6F7;
            text-align: left;
        }

        .card-body {
            padding: 25px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            flex: 1;
        }
		
		#point-log-body {
		    align-items: flex-start !important;
		    overflow-y: auto;
		    max-height: 480px;
		    width: 100% !important;
		}

		#point-log-body .item {
		    width: 100%;
		    border-bottom: 1px solid #eee !important;
		    padding: 15px 0 !important;
		}
        /* ===== CALENDAR STYLES ===== */
        .calendar-body {
            justify-content: center;
            height: 100%;
        }

        .calendar-icon {
            width: 95px;
            height: auto;
            margin-top: -25px;
            margin-bottom: 25px;
        }

        .month-label {
            text-align: center;
            font-weight: bold;
            color: #292929;
            font-size: 24px;
            letter-spacing: 1px;
        }

        .calendar {
            width: 100%;
            text-align: center;
            font-size: 15px;
            border-collapse: collapse;
        }

        .calendar th:first-child {
            color: red;
        }

        .calendar td:nth-child(1) span {
            color: red;
        }

        .calendar th {
            font-weight: normal;
            color: #888;
        }

        .calendar td {
            height: 38px;
        }

        .highlight {
            background-color: #D3BFF9;
            border-radius: 50%;
            display: inline-block;
            width: 28px;
            height: 28px;
            line-height: 28px;
        }

        /* ===== BADGE STYLES ===== */
        .badge-alert {
            background-color: #F8EFFF;
            color: #8B7EF1;
            font-size: 16px;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .badge-alert.hidden {
            display: none;
        }

        .badge-alert p {
            margin: 0;
            line-height: 1.6;
        }

        .badge-alert p .bold {
            font-weight: bold;
        }

        .badge-alert img {
            height: 56px;
            transform: scaleX(-1);
        }

        .badge-list {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            width: 100%;
            margin-left: 10px;
            flex-wrap: wrap;
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 5px;
        }

        .badge-item:hover {
            transform: translateY(-3px);
        }

        .badge-item img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .badge-item.locked img {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .badge-item.unlocked img {
            opacity: 1;
            filter: none;
            border-color: #9C6EF4;
            box-shadow: 0 4px 12px rgba(156, 110, 244, 0.3);
        }

        .badge-name {
            font-size: 11px;
            font-weight: bold;
            margin-top: 6px;
            text-align: center;
            color: #333;
            max-width: 80px;
            word-break: keep-all;
            line-height: 1.2;
        }

        .badge-progress {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
            text-align: center;
        }

        .badge-item.unlocked .badge-progress {
            color: #9C6EF4;
            font-weight: bold;
        }

        .new-badge-indicator {
            position: absolute;
            top: -3px;
            right: -3px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 350px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .toast.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .toast.info {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-message {
            flex: 1;
        }

        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .toast-text {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .main-container {
                margin-left: 0;
            }

            .section-challenge {
                padding: 40px 20px;
            }

            .left-content h2 {
                font-size: 28px;
            }

            .summary-card, .card {
                width: 100%;
                max-width: none;
            }

            .category-buttons {
                justify-content: center;
                width: 100%;
                max-width: none;
            }

            .category-buttons img {
                width: 110px;
            }

            .action-button img {
                width: 80px;
                position: relative;
  				display: inline-block;
            }

            .section-history {
                padding: 60px 20px 40px;
            }

            .section-history h2 {
                font-size: 28px;
                color: #292929;
            }

            .gray-box {
                flex-direction: column;
                gap: 20px;
                padding: 20px;
            }

            .badge-list {
                gap: 10px;
            }

            .badge-item img {
                width: 60px;
                height: 60px;
            }
        }

        /* ===== UTILITIES ===== */
        .label {
            font-size: 16px;
            font-weight: normal;
            color: #292929;
            margin: 10px 0;
            padding: 5px;
        }
        /* ==== ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ==== */
        /* ëª¨ë‹¬ ë°°ê²½ */
		.ocr-modal {
		  display: none;
		  position: fixed;
		  z-index: 1000;
		  left: 0;
		  top: 0;
		  width: 100%;
		  height: 100%;
		  background-color: rgba(0, 0, 0, 0.5);
		  justify-content: center;
		  align-items: center;
		}
		
		/* ëª¨ë‹¬ ë‚´ìš© */
		.ocr-modal-content {
		  background-color: #fff;
		  padding: 30px;
		  border-radius: 20px;
		  text-align: center;
		  width: 320px;
		  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
		  animation: pop 0.2s ease-out;
		}
		
		/* ê·€ì—¬ìš´ ì•„ì´ì½˜ */
		.ocr-icon {
		  width: 80px;
		  margin-bottom: 20px;
		  animation: pop 0.6s ease;
		}
		
		/* ë©”ì‹œì§€ */
		.ocr-message {
		  font-size: 18px;
		  font-weight: bold;
		  margin-bottom: 20px;
		  white-space: nowrap;
		  color: #333;
		}
		
		/* í™•ì¸ ë²„íŠ¼ */
		.ocr-confirm-button {
		  background-color: #A56EFF;
		  color: #fff;
		  border: none;
		  padding: 10px 26px;
		  border-radius: 10px;
		  cursor: pointer;
		  font-size: 16px;
		}
		
		.ocr-confirm-button:hover {
		  background-color: #8b54d7;
		}
		
		/* íŒ ì• ë‹ˆë©”ì´ì…˜ */
		@keyframes pop {
		  0% { transform: scale(0.3); opacity: 0; }
		  100% { transform: scale(1); opacity: 1; }
		}
		/* ì„¤ëª… íˆ´íŒ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
		.tooltip-message {
		  position: absolute;
		  top: 88%;
		  left: 75%; /* ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì•½ê°„ ë–¨ì–´ì§€ê²Œ */
		  transform: translateX(-50%);
		  background-color: #9c5cff;
		  color: #fff;
		  font-size: 15px;
		  padding: 8px 12px;
		  border-radius: 8px;
		  white-space: nowrap;
		  z-index: 10;
		  opacity: 0;
		  pointer-events: none;
		  transition: opacity 0.3s ease;
		}
		.tooltip-message::before {
 		  content: "";
		  position: absolute;
		  top: 50%;
		  left: -16px;
		  transform: translateY(-50%);
		  border-width: 8px;
		  border-style: solid;
		  border-color: transparent #9c5cff transparent transparent; /* ì™¼ìª½ ê¼¬ë¦¬ */
		}
		/* í˜¸ë²„ ì‹œ ë‚˜íƒ€ë‚˜ë„ë¡ ì„¤ì • */
		.action-button:hover .tooltip-message {
		  opacity: 1;
		}
		
    </style>
</head>

<body>
    <!-- ì‚¬ì´ë“œë°” -->
    <div th:replace="common/sidebar :: sidebar"></div>
    
    <div class="toast-container" id="toast-container"></div>
    
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        <!-- ì²« ë²ˆì§¸ ì„¹ì…˜: ì±Œë¦°ì§€ -->
        <div class="section-challenge">
            <div class="left-content">
                <h2>ì„¸ìƒì„ ë°”ê¾¸ëŠ”<br>ì‘ì€ í–‰ë™ì˜ ì‹œì‘</h2>
                <div class="right-content">
                    <div class="summary-card">
                        <div>
                            <b class="nickname" th:text="${session.loginUser.nickname}">ë‹‰ë„¤ì„</b>ë‹˜ì˜ ì ˆì•½ í¬ì¸íŠ¸
                        </div>
                        <div id="summary" th:text="${userPoints != null ? userPoints + 'í¬ì¸íŠ¸' : '0í¬ì¸íŠ¸'}">0í¬ì¸íŠ¸</div>
                    </div>
                    <div class="category-buttons">
                        <img src="/icons/ë¬¼ì ˆì•½.png" alt="ë¬¼ì ˆì•½" onclick="changeCategory('ë¬¼')" />
                        <img src="/icons/ì „ê¸°ì ˆì•½.png" alt="ì „ê¸°ì ˆì•½" onclick="changeCategory('ì „ê¸°')" />
                        <img src="/icons/ìì›ì ˆì•½.png" alt="ìì›ì ˆì•½" onclick="changeCategory('ìì›')" />
                    </div>
                    <div class="card" id="actionCard"></div>
                </div>
            </div>
        </div>

        <!-- ë‘ ë²ˆì§¸ ì„¹ì…˜: íˆìŠ¤í† ë¦¬ -->
        <div class="section-history">
            <h2>ì±Œë¦°ì§€ íˆìŠ¤í† ë¦¬</h2>
            <div class="gray-box">
                <div class="history-card">
                    <div class="card-header calendar-header" id="calendar-title"></div>
                    <div class="card-body calendar-body">
                        <img src="/icons/ì ˆì•½_ë‹¬ë ¥.png" class="calendar-icon">
                        <div class="month-label" id="month-name"></div>
                        <table class="calendar">
                            <thead>
                                <tr>
                                    <th>ì¼</th>
                                    <th>ì›”</th>
                                    <th>í™”</th>
                                    <th>ìˆ˜</th>
                                    <th>ëª©</th>
                                    <th>ê¸ˆ</th>
                                    <th>í† </th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="history-card">
                    <div class="card-header badge-header">ë‚´ ë±ƒì§€</div>
                    <div class="card-body">
						<div class="badge-alert hidden" id="badge-alert">
						    <p>ì¶•í•˜í•´ìš”!<br> <span class="bold">ìƒˆë¡œìš´ ë±ƒì§€ê°€ ìƒê²¼ì–´ìš”!</span></p>
						    <img src="/icons/ì ˆì•½_ë±ƒì§€_ë¡œê³ .png" alt="new badge">
						</div>
                        <div class="badge-list" id="badge-list">
                            <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>
                
                <div class="history-card">
                    <div class="card-header point-header">í¬ì¸íŠ¸ ì ë¦½ ë‚´ì—­</div>
                    <div class="card-body" id="point-log-body" style="align-items: flex-start; overflow-y: auto;">
                        <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ê°€ ë‚´ì—­ ìë™ ì‚½ì… -->
                    </div>
                </div>
            </div>
        </div>
    </div>
	<!-- OCR ê²°ê³¼ ëª¨ë‹¬ -->
	<div id="ocrModal" class="ocr-modal">
	  <div class="ocr-modal-content">
	  	<img src="/icons/challenge_modal.png" alt="ì¶•í•˜" class="ocr-icon">
	    <p id="ocrMessage" class="ocr-message">ë©”ì¼ì„ 00ê°œ ì •ë¦¬í•˜ì…¨ì–´ìš”! ğŸ‘</p>
	    <button onclick="confirmOcrSuccess()" class="ocr-confirm-button">í™•ì¸</button>
	  </div>
	</div>
    <script>
        /* ===== GLOBAL VARIABLES ===== */
        // ì‚¬ìš©ì ì •ë³´
        let loginUser = null;
        let currentUserPoints = 0;
        let isLoggedIn = false;
        let totalPoints = 0;
        let isDataLoaded = false;
        
        // ì±Œë¦°ì§€ ê´€ë ¨
        let currentCategory = 'ë¬¼';
        let todayCompletedChallenges = [];
        
        // ë‹¬ë ¥ ê´€ë ¨
        let monthlyCompletedDates = [];
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth();
		let todayAchievementStatus = false; // ì˜¤ëŠ˜ 8ê°œ ë‹¬ì„± ì—¬ë¶€

        // ë±ƒì§€ ê´€ë ¨
        let badgeDefinitions = [];
        let userBadges = [];
        let newlyEarnedBadges = [];
        let badgeProgress = {};

        // ì±Œë¦°ì§€ ëª©ë¡ ë°ì´í„°
        const challengeData = {
            'ë¬¼': ['ìƒ¤ì›Œì‹œê°„ ì¤„ì´ê¸°', 'ë¹„ëˆ„ì¹ ì‹œ ë¬¼ ì¼œë‘ì§€ì•Šê¸°', 'ì–‘ì¹˜ì»µ ì‚¬ìš©í•˜ê¸°', 'ì„¤ê±°ì§€ ì‹œ ë¬¼ ë°›ì•„ì“°ê¸°', 'ë¹¨ë˜ ëª¨ì•„ì„œ í•˜ê¸°'],
            'ì „ê¸°': ['ë¶ˆí•„ìš”í•œ ì¡°ëª… ë„ê¸°', 'í”ŒëŸ¬ê·¸ ë½‘ê¸°', 'ëŒ€ê¸°ì „ë ¥ ì°¨ë‹¨', 'ì ˆì „ëª¨ë“œ í™œìš©í•˜ê¸°', 'ì ì •ì˜¨ë„ ì¡°ì ˆí•˜ê¸°'],
            'ìì›': ['ë¶„ë¦¬ìˆ˜ê±° ì² ì €íˆ í•˜ê¸°', 'ì¼íšŒìš©í’ˆ ì¤„ì´ê¸°', 'í…€ë¸”ëŸ¬ ì‚¬ìš©í•˜ê¸°', 'ì´ë©”ì¼ ì‚­ì œ ë° ì •ë¦¬', 'ë¹„ë‹ë´‰ì§€ ëŒ€ì‹  ì¥ë°”êµ¬ë‹ˆ']
        };

        const actionIcons = {
            action: '/icons/í–‰ë™.png',
            success: '/icons/ì„±ê³µ.png',
            disabled: '/icons/disabled.png'
        };

        /* ===== TOAST NOTIFICATION FUNCTIONS ===== */
        function showToast(message, type = 'info', title = '', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'ğŸ†',
                warning: 'âš ï¸',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">${icons[type] || icons.info}</div>
                    <div class="toast-message">
                        ${title ? `<div class="toast-title">${title}</div>` : ''}
                        <div class="toast-text">${message}</div>
                    </div>
                    <button class="toast-close" onclick="removeToast(this.parentElement)">Ã—</button>
                </div>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => removeToast(toast), duration);
            return toast;
        }

        function removeToast(toast) {
            if (toast && toast.parentElement) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.parentElement.removeChild(toast);
                    }
                }, 400);
            }
        }

        function showSuccessToast(message, title = 'ì„±ê³µ!') {
            showToast(message, 'success', title);
        }

        function showWarningToast(message, title = 'ì•Œë¦¼') {
            showToast(message, 'warning', title);
        }

        function showInfoToast(message, title = 'ì •ë³´') {
            showToast(message, 'info', title);
        }

        /* ===== SESSION & AUTHENTICATION ===== */
        function checkSessionInfo() {
            console.log('ì„¸ì…˜ ì •ë³´ í™•ì¸ ì‹œì‘');
            $.ajax({
                url: '/challenge/getSessionInfo',
                method: 'POST',
                success: function (response) {
                    console.log('ì„¸ì…˜ ì •ë³´ ì‘ë‹µ:', response);
                    if (response.success) {
                        loginUser = response.loginUser;
                        currentUserPoints = response.userPoints || 0;
                        totalPoints = currentUserPoints;
                        isLoggedIn = true;
                        console.log('ë¡œê·¸ì¸ ì„±ê³µ - ì‚¬ìš©ì:', loginUser.nickname, 'í¬ì¸íŠ¸:', totalPoints);
                    } else {
                        console.log('ì„¸ì…˜ì— ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ');
                        resetUserData();
                    }
                    initializePage();
                },
                error: function (xhr, status, error) {
                    console.error('ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    resetUserData();
                    initializePage();
                }
            });
        }

        function resetUserData() {
            loginUser = null;
            currentUserPoints = 0;
            totalPoints = 0;
            isLoggedIn = false;
        }

        function checkLoginStatus() {
            if (!isLoggedIn || !loginUser) {
                console.log('ë¡œê·¸ì•„ì›ƒ ìƒíƒœì…ë‹ˆë‹¤.');
                return false;
            }
            return true;
        }

        /* ===== PAGE INITIALIZATION ===== */
        function initializePage() {
            console.log('í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘ - ë¡œê·¸ì¸ ìƒíƒœ:', isLoggedIn);
            
            updateSummary();
            renderCard();
            initializeCalendar();

            if (isLoggedIn) {
                loadTodayCompletedChallenges();
                loadPointHistory();
                loadBadgeDefinitions();
            } else {
                isDataLoaded = true;
                renderDefaultBadges();
            }
            
            console.log('í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        /* ===== BADGE FUNCTIONS ===== */
        function loadBadgeDefinitions() {
            console.log('ë±ƒì§€ ì •ì˜ ë¡œë“œ ì‹œì‘');
            $.ajax({
                url: '/badge/getBadgeDefinitions',
                method: 'POST',
                success: function (response) {
                    console.log('ë±ƒì§€ ì •ì˜ ì‘ë‹µ:', response);
                    badgeDefinitions = response.success ? (response.badges || []) : [];
                    loadUserBadges();
                },
                error: function (xhr, status, error) {
                    console.error('ë±ƒì§€ ì •ì˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    badgeDefinitions = [];
                    loadUserBadges();
                }
            });
        }

        function loadUserBadges() {
            console.log('ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ ì‹œì‘');
            if (!checkLoginStatus()) {
                userBadges = [];
                badgeProgress = {};
                renderBadges();
                return;
            }

            $.ajax({
                url: '/challenge/getUserBadges',
                method: 'POST',
                success: function (response) {
                    console.log('ì‚¬ìš©ì ë±ƒì§€ ì‘ë‹µ:', response);
                    if (response.success) {
                        userBadges = response.badges || [];
                        loadBadgeProgress();
                    } else {
                        userBadges = [];
                        badgeProgress = {};
                        renderBadges();
                    }
                },
                error: function (xhr, status, error) {
                    console.error('ì‚¬ìš©ì ë±ƒì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    userBadges = [];
                    badgeProgress = {};
                    renderBadges();
                }
            });
        }

        function loadBadgeProgress() {
            console.log('ë±ƒì§€ ì§„í–‰ë„ ë¡œë“œ ì‹œì‘');
            if (!checkLoginStatus()) {
                badgeProgress = {};
                renderBadges();
                return;
            }

            $.ajax({
                url: '/challenge/getCategoryProgress',
                method: 'POST',
                success: function (response) {
                    console.log('ë±ƒì§€ ì§„í–‰ë„ ì‘ë‹µ:', response);
                    badgeProgress = response.success ? (response.progress || {}) : {};
                    checkForNewBadges();
                    renderBadges();
                },
                error: function (xhr, status, error) {
                    console.error('ë±ƒì§€ ì§„í–‰ë„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    badgeProgress = {};
                    renderBadges();
                }
            });
        }

        function renderBadges() {
            console.log('ë±ƒì§€ ë Œë”ë§ ì‹œì‘');
            const badgeList = document.getElementById('badge-list');
            if (!badgeList) {
                console.error('badge-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            badgeList.innerHTML = '';

            const defaultBadges = [
                {badgeId: 'water_badge01', badgeName: 'ë¬¼ ì ˆì•½ ì´ˆì‹¬ì', category: 'ë¬¼'},
                {badgeId: 'energy_badge01', badgeName: 'ì—ë„ˆì§€ ì ˆì•½ ì´ˆì‹¬ì', category: 'ì „ê¸°'},
                {badgeId: 'waste_badge01', badgeName: 'ìì› ì ˆì•½ ì´ˆì‹¬ì', category: 'ìì›'}
            ];

            const badges = badgeDefinitions.length > 0 ? badgeDefinitions : defaultBadges;
            console.log('ë Œë”ë§í•  ë±ƒì§€ë“¤:', badges);

            badges.forEach(badge => {
                const badgeItem = createBadgeItem(badge);
                badgeList.appendChild(badgeItem);
            });

            updateBadgeAlert();
            console.log('ë±ƒì§€ ë Œë”ë§ ì™„ë£Œ');
        }

        function createBadgeItem(badge) {
            const badgeItem = document.createElement('div');
            badgeItem.className = 'badge-item';

            const isUnlocked = userBadges.some(userBadge => userBadge.BADGEID === badge.badgeId);
            const currentProgress = badgeProgress[badge.category] || 0;

            console.log(`ë±ƒì§€ ${badge.badgeId}: ë³´ìœ =${isUnlocked}, ì§„í–‰ë„=${currentProgress}`);

            badgeItem.classList.add(isUnlocked ? 'unlocked' : 'locked');

            // ë±ƒì§€ ì´ë¯¸ì§€
            const img = document.createElement('img');
            if (isUnlocked) {
                img.src = `/badge/image/${badge.badgeId}`;
            } else {
                img.src = getDefaultBadgeImage(badge.category);
                img.style.filter = 'grayscale(100%) opacity(0.3)';
            }

            // ë±ƒì§€ ì´ë¦„
            const name = document.createElement('div');
            name.className = 'badge-name';
            name.textContent = badge.badgeName;

            // ì§„í–‰ë„
            const progress = document.createElement('div');
            progress.className = 'badge-progress';
            progress.textContent = isUnlocked ? 'ì™„ë£Œ!' : `${currentProgress}/5`;

            badgeItem.appendChild(img);
            badgeItem.appendChild(name);
            badgeItem.appendChild(progress);

            // ìƒˆ ë±ƒì§€ í‘œì‹œ
            if (newlyEarnedBadges.includes(badge.badgeId)) {
                const newIndicator = document.createElement('div');
                newIndicator.className = 'new-badge-indicator';
                newIndicator.textContent = 'N';
                badgeItem.appendChild(newIndicator);
            }

            // í´ë¦­ ì´ë²¤íŠ¸
            badgeItem.onclick = () => showBadgeDetails(badge, isUnlocked, currentProgress);

            return badgeItem;
        }

        function renderDefaultBadges() {
            console.log('ê¸°ë³¸ ë±ƒì§€ ë Œë”ë§');
            badgeDefinitions = [];
            userBadges = [];
            badgeProgress = {};
            renderBadges();
        }

        function getDefaultBadgeImage(category) {
            const defaultImages = {
                'ë¬¼': '/icons/ë¬¼ì ˆì•½.png',
                'ì „ê¸°': '/icons/ì „ê¸°ì ˆì•½.png',
                'ìì›': '/icons/ìì›ì ˆì•½.png'
            };
            return defaultImages[category] || '/icons/default_badge.png';
        }

        function showBadgeDetails(badge, isUnlocked, currentProgress) {
            if (isUnlocked) {
                showSuccessToast(`${badge.badgeName} ë±ƒì§€ë¥¼ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!`, 'ë±ƒì§€ ë³´ìœ  ğŸ†');
            } else {
                showInfoToast(`5ê°œ ì™„ë£Œ ì‹œ íšë“ (í˜„ì¬: ${currentProgress}/5)`, badge.badgeName);
            }
        }

        function updateBadgeAlert() {
            const badgeAlert = document.getElementById('badge-alert');
            const newBadgeName = document.getElementById('new-badge-name');

            if (!badgeAlert) return;

            if (newlyEarnedBadges.length > 0) {

                badgeAlert.classList.remove('hidden');

                setTimeout(() => {
                    badgeAlert.classList.add('hidden');
                }, 5000);
            } else {
                badgeAlert.classList.add('hidden');
            }
        }

        function checkForNewBadges() {
            const today = new Date();
            const todayString = today.toDateString();

            newlyEarnedBadges = userBadges
                .filter(badge => {
                    if (!badge.awardedDate) return false;
                    const awardedDate = new Date(badge.awardedDate);
                    return awardedDate.toDateString() === todayString;
                })
                .map(badge => badge.badgeId);

            console.log('ì˜¤ëŠ˜ íšë“í•œ ìƒˆ ë±ƒì§€:', newlyEarnedBadges);
        }

        /* ===== CHALLENGE FUNCTIONS ===== */
        function loadTodayCompletedChallenges() {
            if (!checkLoginStatus()) {
                isDataLoaded = true;
                renderCard();
                return;
            }

            $.ajax({
                url: '/challenge/getTodayCompleted',
                method: 'POST',
                contentType: 'application/json',
                success: function (response) {
                    console.log('ì™„ë£Œëœ ì±Œë¦°ì§€ ì„œë²„ ì‘ë‹µ:', response);
                    if (response.success) {
                        todayCompletedChallenges = response.completedChallenges || [];
                        console.log('ì˜¤ëŠ˜ ì™„ë£Œí•œ ì±Œë¦°ì§€:', todayCompletedChallenges);
                    } else {
                        console.log('ì™„ë£Œëœ ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', response.message);
                        todayCompletedChallenges = [];
                    }
                    isDataLoaded = true;
                    renderCard();
					checkTodayAchievement();
                },
                error: function (xhr, status, error) {
                    console.error('ì™„ë£Œëœ ì±Œë¦°ì§€ ì¡°íšŒ ì‹¤íŒ¨:', error);
                    todayCompletedChallenges = [];
                    isDataLoaded = true;
                    renderCard();
                }
            });
        }

        function savePointsToServer(challengeName) {
            if (!checkLoginStatus()) {
                showWarningToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!', 'ë¡œê·¸ì¸ í•„ìš”');
                setTimeout(() => {
                    window.location.href = '/sign';
                }, 2000);
                return;
            }

            console.log('í¬ì¸íŠ¸ ì €ì¥ ì‹œë„:', challengeName);

            if (!challengeName || challengeName.trim() === '') {
                console.error('ì±Œë¦°ì§€ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            $.ajax({
                url: '/challenge/earnPoints',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    challengeName: challengeName
                }),
                success: function (response) {
                    console.log('í¬ì¸íŠ¸ ì €ì¥ ì‘ë‹µ:', response);
                    if (response.success) {
                        totalPoints = response.totalPoints;
                        updateSummary();

                        if (!todayCompletedChallenges.includes(challengeName)) {
                            todayCompletedChallenges.push(challengeName);
                        }

                        loadPointHistory();
                        loadUserBadges();

                        console.log('í¬ì¸íŠ¸ ì ë¦½ ì™„ë£Œ:', challengeName);
                        renderCard();
						
						checkTodayAchievement();

                        showSuccessToast('100í¬ì¸íŠ¸ê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'ì±Œë¦°ì§€ ì™„ë£Œ ğŸ‰');

                        if (response.newBadge && response.newBadge.newBadgeEarned) {
                            setTimeout(() => {
                                showSuccessToast(`${response.newBadge.badgeName} ë±ƒì§€ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`, 'ë±ƒì§€ íšë“ ğŸ†');
                            }, 1500);
                        }
                    } else {
                        if (response.alreadyCompleted) {
                            showInfoToast('ì˜¤ëŠ˜ ì´ë¯¸ ì™„ë£Œí•œ ì±Œë¦°ì§€ì…ë‹ˆë‹¤', 'ì™„ë£Œë¨');
                        } else {
                            console.error('í¬ì¸íŠ¸ ì ë¦½ ì‹¤íŒ¨:', response.message);
                            showWarningToast('í¬ì¸íŠ¸ ì ë¦½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'ì˜¤ë¥˜ ë°œìƒ');
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error('í¬ì¸íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
                    if (xhr.status === 401 || xhr.status === 403) {
                        showWarningToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!', 'ë¡œê·¸ì¸ í•„ìš”');
                        setTimeout(() => {
                            window.location.href = '/sign';
                        }, 2000);
                    } else {
                        showWarningToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'ì—°ê²° ì‹¤íŒ¨');
                    }
                }
            });
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            if (isLoggedIn) {
                summary.textContent = `${totalPoints}í¬ì¸íŠ¸`;
            } else {
                summary.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
            }
        }

        function isChallengeCompleted(challengeName) {
            return isLoggedIn && todayCompletedChallenges.includes(challengeName);
        }
        
        

        function renderCard() {
            console.log('renderCard í˜¸ì¶œë¨, ì¹´í…Œê³ ë¦¬:', currentCategory);
            console.log('ë¡œê·¸ì¸ ìƒíƒœ:', isLoggedIn);
            console.log('ì™„ë£Œëœ ì±Œë¦°ì§€ë“¤:', todayCompletedChallenges);

            const container = document.getElementById('actionCard');
            if (!container) {
                console.error('actionCard ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

            container.innerHTML = '';

            challengeData[currentCategory].forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';

                const label = document.createElement('div');
                label.textContent = item;

                const btn = document.createElement('div');
                btn.className = 'action-button';
                const img = document.createElement('img');
                
                if (item === 'ì´ë©”ì¼ ì‚­ì œ ë° ì •ë¦¬') {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip-message';
                    tooltip.textContent = 'ì´ë©”ì¼ ì •ë¦¬ ì „/í›„ ì‚¬ì§„ì„ ì²¨ë¶€í•´ì£¼ì„¸ìš”.';
                    btn.appendChild(tooltip); // action-button ì•ˆì— ì„¤ëª… ì‚½ì…
                }

                if (!isLoggedIn) {
                    img.src = actionIcons.action;
                    img.alt = 'login-required';
                    img.style.opacity = '0.5';
                    img.onclick = () => {
                        showWarningToast('ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!', 'ë¡œê·¸ì¸ í•„ìš”');
                        setTimeout(() => {
                            window.location.href = '/sign';
                        }, 2000);
                    };
                } else {
                    const challengeName = `${currentCategory} - ${item}`;
                    const isCompleted = isChallengeCompleted(challengeName);

                    img.src = isCompleted ? actionIcons.success : actionIcons.action;
                    img.alt = isCompleted ? 'success' : 'action';

                    img.onclick = () => {
                        console.log(`${challengeName} í´ë¦­ë¨`);

                        if (!isCompleted) {
                        	 // âœ… "ìì› - ì´ë©”ì¼ ì‚­ì œ ë° ì •ë¦¬"ë§Œ OCR ì—…ë¡œë“œ ì§„í–‰
                        	 if (challengeName === "ìì› - ì´ë©”ì¼ ì‚­ì œ ë° ì •ë¦¬") {
					            const fileInput = document.createElement("input");
					            fileInput.type = "file";
					            fileInput.accept = "image/*";
					            fileInput.multiple = true;  // âœ… ì—¬ëŸ¬ íŒŒì¼ ì„ íƒ í—ˆìš©
					
					            fileInput.onchange = async function () {
					            	const files = fileInput.files;
					                if (files.length !== 2) {
					                    showWarningToast("ì´ë¯¸ì§€ 2ì¥ì„ ì„ íƒí•´ì£¼ì„¸ìš”!", "íŒŒì¼ ë¶€ì¡±");
					                    return;
					                }
					                
					                const formData = new FormData();
					                for (let i = 0; i < 2; i++) {
					                    formData.append("files", files[i]);  // âœ… í‚¤ ì´ë¦„ì€ Flaskì—ì„œë„ "files"ë¡œ ë°›ì•„ì•¼ í•¨
					                }
					
					                const response = await fetch("http://192.168.0.35:5000/ocr/challenge", {
					                    method: "POST",
					                    body: formData
					                });
					
					                const data = await response.json();
					                
					                if (data.success) {
					                    // ì´ë©”ì¼ ì •ë¦¬ ì„±ê³µ ì‹œ í¬ì¸íŠ¸ ì ë¦½
					                    const cleaned = data.cleaned_count;
					                    showOcrModal(cleaned);
					                    /* showSuccessToast(`ë©”ì¼ì„ ${cleaned}ê°œ ì •ë¦¬í•˜ì…¨ì–´ìš”! ğŸ‘`, "ì„±ê³µ"); */
					                    /* savePointsToServer(challengeName); */
					                } else {
					                	showWarningToast("ë©”ì¼ ì •ë¦¬ ì¸ì¦ ì‹¤íŒ¨ ğŸ˜¢ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "ì‹¤íŒ¨");
					                }
					            };
					            fileInput.click();
					          } else {
							// ë‚˜ë¨¸ì§€ ì±Œë¦°ì§€
                            savePointsToServer(challengeName);
					         }
                        } else {
                            console.log('ì˜¤ëŠ˜ ì´ë¯¸ ì™„ë£Œí•œ ì±Œë¦°ì§€ì…ë‹ˆë‹¤.');
                            showInfoToast('ì˜¤ëŠ˜ ì´ë¯¸ ì™„ë£Œí•œ ì±Œë¦°ì§€ì…ë‹ˆë‹¤', 'ì™„ë£Œë¨');
                        }
                    };
                }

                btn.appendChild(img);
                itemDiv.appendChild(label);
                itemDiv.appendChild(btn);
                container.appendChild(itemDiv);
            });

            console.log('ì¹´ë“œ ë Œë”ë§ ì™„ë£Œ');
        }
        
        /* ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ + Toast ì—°ê²° */
         function showOcrModal(cleanedCount) {
        	  document.getElementById("ocrMessage").textContent = `ë©”ì¼ì„ ${cleanedCount}ê°œ ì •ë¦¬í•˜ì…¨ì–´ìš”! ğŸ‘`;
        	  document.getElementById("ocrModal").style.display = "flex";
        	}
         function closeOcrModal() {
        	    document.getElementById("ocrModal").style.display = "none";
        	}

       	function confirmOcrSuccess() {
     	  closeOcrModal(); // ëª¨ë‹¬ ë‹«ê³ 
	      //showSuccessToast('100í¬ì¸íŠ¸ê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'ì±Œë¦°ì§€ ì™„ë£Œ ğŸ‰'); // í¬ì¸íŠ¸ ì•Œë¦¼
	      savePointsToServer("ìì› - ì´ë©”ì¼ ì‚­ì œ ë° ì •ë¦¬"); // âœ… ì‹¤ì œ í¬ì¸íŠ¸ ì €ì¥
       	}

        function changeCategory(cat) {
            currentCategory = cat;
            renderCard();
        }

        /* ===== CALENDAR FUNCTIONS ===== */

		function checkTodayAchievement() {
		    console.log('ì˜¤ëŠ˜ ë‹¬ì„± ìƒíƒœ í™•ì¸:', todayCompletedChallenges.length);
		    
		    // 8ê°œ ì´ìƒ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
		    if (todayCompletedChallenges.length >= 8) {
		        todayAchievementStatus = true;
		        updateCalendarHighlight();
		        
		        // ì²˜ìŒ 8ê°œ ë‹¬ì„± ì‹œ ì¶•í•˜ ë©”ì‹œì§€ (1.5ì´ˆ í›„)
		        if (todayCompletedChallenges.length === 8) {
		            setTimeout(() => {
		                showSuccessToast('ì˜¤ëŠ˜ 8ê°œ ì±Œë¦°ì§€ë¥¼ ëª¨ë‘ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!', 'ì¼ì¼ ëª©í‘œ ë‹¬ì„± ğŸ‰');
		            }, 1500);
		        }
		    } else {
		        todayAchievementStatus = false;
		        updateCalendarHighlight();
		    }
		}

		function updateCalendarHighlight() {
		    const today = new Date();
		    const todayDate = today.getDate();
		    
		    // í˜„ì¬ í‘œì‹œëœ ë‹¬ë ¥ì´ ì´ë²ˆ ë‹¬ì¸ì§€ í™•ì¸
		    if (currentCalendarYear === today.getFullYear() && 
		        currentCalendarMonth === today.getMonth()) {
		        
		        const calendarCells = document.querySelectorAll('#calendar-body td span');
		        calendarCells.forEach(span => {
		            if (parseInt(span.textContent) === todayDate) {
		                if (todayAchievementStatus) {
		                    span.className = 'highlight';
		                } else {
		                    span.className = '';
		                }
		            }
		        });
		    }
		}

        function initializeCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

            document.getElementById('calendar-title').textContent = `${month + 1}ì›” ì±Œë¦°ì§€ ë‹¬ì„±`;
            document.getElementById('month-name').textContent = monthNames[month];

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            const tbody = document.getElementById('calendar-body');
            tbody.innerHTML = '';
            let row = document.createElement('tr');

            // ë¹ˆ ì…€ ì¶”ê°€
            for (let i = 0; i < firstDay; i++) {
                row.appendChild(document.createElement('td'));
            }

            // ë‚ ì§œ ì…€ ì¶”ê°€
            for (let date = 1; date <= lastDate; date++) {
                const cell = document.createElement('td');
                const span = document.createElement('span');
                span.textContent = date;

                // í•˜ë“œì½”ë”©ëœ í•˜ì´ë¼ì´íŠ¸ ë‚ ì§œ (ì˜ˆì‹œ)
                if (isLoggedIn && [].includes(date)) {
                    span.className = 'highlight';
                }

                cell.appendChild(span);
                row.appendChild(cell);

                if ((firstDay + date) % 7 === 0) {
                    tbody.appendChild(row);
                    row = document.createElement('tr');
                }
            }

            if (row.children.length > 0) tbody.appendChild(row);
        }

        /* ===== POINT HISTORY FUNCTIONS ===== */
        function loadPointHistory() {
            if (!checkLoginStatus()) {
                return;
            }

            $.ajax({
                url: '/challenge/getPointHistory',
                method: 'POST',
                success: function (response) {
                    console.log('í¬ì¸íŠ¸ ë‚´ì—­ ì‘ë‹µ:', response);
                    if (response.success && response.pointHistory) {
                        displayPointHistory(response.pointHistory);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨:', error);
                }
            });
        }

        function displayPointHistory(historyList) {
            const pointLogBody = document.getElementById('point-log-body');
            if (!pointLogBody) return;

            pointLogBody.innerHTML = '';

            if (!historyList || historyList.length === 0) {
                pointLogBody.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 20px;">
                        ì•„ì§ í¬ì¸íŠ¸ ì ë¦½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤
                    </div>
                `;
                return;
            }

            historyList.forEach(history => {
                const logEntry = createPointHistoryEntry(history);
                pointLogBody.appendChild(logEntry);
            });
        }

		function createPointHistoryEntry(history) {
		    const logEntry = document.createElement('div');
		    logEntry.classList.add('item');
		    logEntry.style.borderBottom = '1px solid #eee';
		    logEntry.style.padding = '15px 0';

		    // ë‚ ì§œ ì²˜ë¦¬
		    let timeString = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
		    try {
		        if (history.AWARDEDDATE) {
		            const date = new Date(history.AWARDEDDATE);
		            if (!isNaN(date.getTime())) {
		                timeString = date.toLocaleString('ko-KR', {
		                    year: 'numeric',
		                    month: '2-digit',
		                    day: '2-digit',
		                    hour: '2-digit',
		                    minute: '2-digit'
		                });
		            }
		        }
		    } catch (e) {
		        console.error('Date parsing error:', e);
		        timeString = 'ë‚ ì§œ ì˜¤ë¥˜';
		    }

		    // ì¹´í…Œê³ ë¦¬ë³„ ì´ëª¨ì§€
		    const categoryEmojis = {
		        'ë¬¼': 'ğŸ’§',
		        'ì „ê¸°': 'âš¡',
		        'ìì›': 'â™»ï¸'
		    };

		    // ì±Œë¦°ì§€ëª…ì—ì„œ ì¹´í…Œê³ ë¦¬ì™€ ì œëª© ë¶„ë¦¬
		    let category = '';
		    let challengeTitle = history.REASON || 'ì±Œë¦°ì§€ ì™„ë£Œ';
		    
		    if (history.REASON && history.REASON.includes(' - ')) {
		        const parts = history.REASON.split(' - ');
		        category = parts[0];
		        challengeTitle = parts[1];
		    }

		    const emoji = categoryEmojis[category] || 'ğŸ†';
		    const points = history.POINTHISTORY || 100;

		    // HTML ìƒì„±
		    logEntry.innerHTML = `
		        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
		            <div style="flex: 1;">
		                <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px; color: #333;">
		                    ${emoji} <span style="color: #9C6EF4;">+${points}ì </span>
		                </div>
		                <div style="font-size: 14px; color: #666;">
		                    ${challengeTitle}
		                </div>
		            </div>
		            <div style="font-size: 12px; color: #888; text-align: right; white-space: nowrap; margin-left: 10px;">
		                ${timeString}
		            </div>
		        </div>
		    `;

		    return logEntry;
		}
		/* ===== PAGE LOAD ===== */
        window.onload = () => {
            console.log('í˜ì´ì§€ ë¡œë“œ - ì„¸ì…˜ ì •ë³´ í™•ì¸ ì‹œì‘');
            checkSessionInfo();
        };
    </script>

</body>

</html>