<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ì ˆì•½ ì±Œë¦°ì§€ | A.P.T</title>

<link rel="stylesheet" th:href="@{/css/font.css}" />
<link rel="stylesheet" href="/css/sidebar.css">
<!-- Favicon -->
<link rel="icon" href="/icons/favicon.png" type="image/png">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
* {
	box-sizing: border-box;
}

body {
	margin: 0;
	padding: 0;
	background-color: #fdfdfd;
	display: flex;
	flex-direction: column; /* ì¶”ê°€: ìì‹ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ì •ë ¬ */
	min-height: 100vh; /* ë³€ê²½: ìµœì†Œ ë†’ì´ë¥¼ ë·°í¬íŠ¸ ë†’ì´ì˜ 100%ë¡œ ì„¤ì • */
	overflow-y: auto; /* ë³€ê²½: í•„ìš”í•  ë•Œë§Œ ìŠ¤í¬ë¡¤ë°”ê°€ ìƒê¸°ë„ë¡ */
	/* height: 100vh;ê³¼ overflow: hidden;ì€ ì œê±°í•˜ê±°ë‚˜ min-height, overflow-y: autoë¡œ ë³€ê²½ */
}

.main {
	flex: 1; /* ë³€ê²½: ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
	margin-left: 100px; /* ì‚¬ì´ë“œë°” ë„ˆë¹„ë§Œí¼ ì™¼ìª½ ë§ˆì§„ */
	padding: 40px;
	/* height: 100vh; ì´ ë¶€ë¶„ì€ ì œê±° */
	overflow-y: auto; /* main ì˜ì—­ì—ì„œë§Œ ìŠ¤í¬ë¡¤ì´ í•„ìš”í•˜ë©´ auto */
	display: flex;
	flex-direction: column;
}

.grid {
	display: grid;
	grid-template-areas:
		"challenge challenge link"
		"rank point badge"
		"rank tip tip";
	grid-template-columns: 1.7fr 1fr 1.1fr;
	grid-template-rows: auto 1fr 1.2fr;
	gap: 16px;
	height: 100%; /* ë¶€ëª¨(main)ì˜ ë†’ì´ì— ë§ì¶”ê¸° */
	width: 100%;
	max-width: 950px;
	margin: 0 auto;
	padding-bottom: 20px; /* ê·¸ë¦¬ë“œ í•˜ë‹¨ ì—¬ë°± */
}

/* ëª¨ë“  ì¹´ë“œì˜ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.card {
	background: #fff;
	border-radius: 12px;
	padding: 24px;
	box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
	display: flex;
	flex-direction: column;
	justify-content: space-between; /* ë‚´ìš©ì´ ìœ„ì•„ë˜ë¡œ ë¶„ì‚°ë˜ë„ë¡ */
	border: 1px solid #f0f0f0;
	overflow: hidden; /* ë‚´ìš©ì´ ì¹´ë“œ ë°–ìœ¼ë¡œ ë„˜ì¹˜ëŠ” ê²ƒì„ ë°©ì§€ */
}

/* ê° ê·¸ë¦¬ë“œ ì˜ì—­ì— í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ ì´ë¦„ê³¼ ë§¤ì¹­ */
.challenge {
    grid-area: challenge;
    padding: 0;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.challenge img {
	width: 100%;
	height: 100%;
	object-fit: cover; /* ì´ë¯¸ì§€ê°€ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©° ì˜ì—­ì„ ë®ë„ë¡ ì¡°ì • */
	border-radius: 12px;
}

.link {
    grid-area: link;
    padding: 0;
    background: none; /* ë°°ê²½ìƒ‰ ì œê±° (íˆ¬ëª…í•˜ê²Œ) */
    box-shadow: none; /* ê·¸ë¦¼ì ì œê±° (ì´ë¯¸ì§€ì—ë§Œ ì¤„ ê²ƒì´ë¯€ë¡œ) */
    border: none; /* í…Œë‘ë¦¬ ì œê±° */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* ì´ë¯¸ì§€ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ (ì—¬ì „íˆ ì¤‘ìš”!) */
}

.link a {
    display: block;
    width: 100%;
    height: 100%;
    display: flex; /* flex ì»¨í…Œì´ë„ˆë¡œ ë§Œë“¤ì–´ ì´ë¯¸ì§€ ì¤‘ì•™ ì •ë ¬ì„ ë•ìŠµë‹ˆë‹¤. */
    align-items: center;
    justify-content: center;
}

.link img {
    max-width: 100%; /* ë¶€ëª¨(a íƒœê·¸)ì˜ 100%ë¥¼ ì°¨ì§€ */
    height: auto; /* ë¶€ëª¨(a íƒœê·¸)ì˜ 100%ë¥¼ ì°¨ì§€ */
    object-fit: contain; /* ì´ë¯¸ì§€ê°€ ì˜ë¦¬ì§€ ì•Šê³  í¬í•¨ë˜ë„ë¡ */
    border-radius: 12px;
    cursor: pointer;
    display: block;
    transition: transform 0.3s ease;
}

.link a {
display: block;
width: 100%; /* a íƒœê·¸ê°€ link ì˜ì—­ì„ ê½‰ ì±„ìš°ë„ë¡ */
height: 100%;
display: flex;
align-items: center;
justify-content: center;
}

/* ë‚˜ë¨¸ì§€ ì¹´ë“œë“¤ë„ .card í´ë˜ìŠ¤ì™€ grid-area í´ë˜ìŠ¤ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ë„ë¡ */
.rank {
	grid-area: rank;
}
.point {
	grid-area: point;
}
.badge {
	grid-area: badge;
}
.tip {
	grid-area: tip;
}

.highlight {
	font-size: 2rem;
	font-weight: bold;
	color: #AB66FF;
	margin: 0;
}

.point-text {
	font-size: 1.2rem;
	color: #525A6B;
	margin: 0;
}

/* í¬ì¸íŠ¸ ì¹´ë“œ ë ˆì´ì•„ì›ƒ ìˆ˜ì • */
.point-display {
	display: flex;
	flex-direction: row; /* columnì—ì„œ rowë¡œ ë³€ê²½ */
	align-items: center;
	justify-content: center;
	flex: 1;
	gap: 8px;
}

.card h3 {
	margin: 0 0 1px;
	font-size: 1.3rem;
	color: #292929;
}

.rank h3 {
    margin: 0 0 8px; /* ì ë‹¹í•œ ê°„ê²© */
    font-size: 1.3rem;
    color: #292929;
}

.rank-item {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
}

/* ë‹‰ë„¤ì„ ê¸€ì í¬ê¸° */
.rank-item span:first-child {
    font-size: 20px;
}

/* í¬ì¸íŠ¸ ê¸€ì í¬ê¸° ë° ìƒ‰ìƒ */
.rank-item span:last-child {
    font-size: 15px;
    color: #525A6B;
}

.tip-content {
	line-height: 1.6;
	font-size: 0.95rem;
	color: #444;
}

footer {
	background-color: #f2f2f2;
	padding: 15px 0;
	text-align: center;
	font-size: 14px;
	color: #666;
	width: 100%;
	flex-shrink: 0; /* ì¶”ê°€: í‘¸í„°ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
}
</style>
</head>

<script>
	// ì„¸ì…˜ ì •ë³´ë¡œ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
	function updateMainPagePoints() {
	    $.ajax({
	        url: '/challenge/getSessionInfo',
	        method: 'POST',
	        success: function(response) {
	           // console.log('ë©”ì¸í˜ì´ì§€ ì„¸ì…˜ ì‘ë‹µ:', response);
	            if (response.success && response.loginUser) {
	               // console.log('ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', response.loginUser.nickname);
	              // console.log('ì‚¬ìš©ì í¬ì¸íŠ¸:', response.userPoints);
	                
	                // í¬ì¸íŠ¸ ì¹´ë“œì˜ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸
	                const pointCard = document.querySelector('.card.point');
	                if (pointCard) {
	                    const pointsDisplay = response.userPoints || 0;
	                    pointCard.innerHTML = `
	                        <h3>ë‚´ í¬ì¸íŠ¸</h3>
	                        <div class="point-display">
	                            <span class="highlight">${pointsDisplay}</span>
	                            <span class="point-text">í¬ì¸íŠ¸</span>
	                        </div>
	                    `;
	                   // console.log('í¬ì¸íŠ¸ ì¹´ë“œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', pointsDisplay);
	                }
	                
	                // ë±ƒì§€ ì •ë³´ë„ ì—…ë°ì´íŠ¸
	                updateMainPageBadges();
	            } else {
	               // console.log('ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ë˜ëŠ” ì„¸ì…˜ ì •ë³´ ì—†ìŒ');
	                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì¼ ë•Œ
	                const pointCard = document.querySelector('.card.point');
	                if (pointCard) {
						pointCard.innerHTML = `
						    <h3>ë‚´ í¬ì¸íŠ¸</h3>
						    <div class="point-display">
						        <span class="highlight">${pointsDisplay}</span>
						        <span class="point-text">í¬ì¸íŠ¸</span>
						    </div>
						`;
	                }
	                
	                // ë±ƒì§€ë„ ê¸°ë³¸ ìƒíƒœë¡œ
	                const badgeCard = document.querySelector('.card.badge');
	                if (badgeCard) {
	                    badgeCard.innerHTML = `
	                        <h3>ë‚´ ë±ƒì§€</h3>
	                        <div style="text-align: center; color: #888; font-size: 0.9rem; padding: 20px 0;">
	                            ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
	                        </div>
	                    `;
	                }
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error('ì„¸ì…˜ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
	            console.error('ì‘ë‹µ ìƒíƒœ:', xhr.status);
	            console.error('ì‘ë‹µ í…ìŠ¤íŠ¸:', xhr.responseText);
	            
	            // ì˜¤ë¥˜ ì‹œì—ë„ ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ í‘œì‹œ
	            const pointCard = document.querySelector('.card.point');
	            if (pointCard) {
	                pointCard.innerHTML = `
	                    <h3>ë‚´ í¬ì¸íŠ¸</h3>
	                    <div class="point-display">
	                        <span style="font-size: 1rem; color: #888;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
	                    </div>
	                `;
	            }
	        }
	    });
	}

	// ë©”ì¸ í˜ì´ì§€ ë±ƒì§€ ì—…ë°ì´íŠ¸
	function updateMainPageBadges() {
	    $.ajax({
	        url: '/challenge/getUserBadges',
	        method: 'POST',
	        success: function(response) {
	            console.log('ë©”ì¸í˜ì´ì§€ ë±ƒì§€ ì‘ë‹µ:', response);
	            if (response.success && response.badges) {
	                const badgeCard = document.querySelector('.card.badge');
	                if (badgeCard && response.badges.length > 0) {
	                    let badgeHTML = '<h3>ë‚´ ë±ƒì§€</h3>';
	                    
	                    // ìµœëŒ€ 3ê°œì˜ ë±ƒì§€ë§Œ í‘œì‹œ (ê³µê°„ ì œì•½)
	                    const displayBadges = response.badges.slice(0, 3);
	                    
	                    displayBadges.forEach(badge => {
	                        badgeHTML += `
	                            <div class="badge-item" style="margin-bottom: 8px;">
	                                <span style="font-size: 1.2rem;">ğŸ†</span>
	                                <span style="font-size: 1.1rem;">${badge.BADGENAME}</span>
	                            </div>
	                        `;
	                    });
	                    
	                    if (response.badges.length > 3) {
	                        badgeHTML += `<p style="font-size: 0.8rem; color: #777; margin: 10px 0 0;">ì™¸ ${response.badges.length - 3}ê°œ</p>`;
	                    }
	                    
	                    badgeCard.innerHTML = badgeHTML;
	                } else {
	                    // ë±ƒì§€ê°€ ì—†ëŠ” ê²½ìš°
	                    const badgeCard = document.querySelector('.card.badge');
	                    if (badgeCard) {
	                        badgeCard.innerHTML = `
	                            <h3>ë‚´ ë±ƒì§€</h3>
	                            <div style="text-align: center; color: #888; font-size: 0.9rem; padding: 20px 0;">
	                                ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤
	                            </div>
	                        `;
	                    }
	                }
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error('ë±ƒì§€ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
	        }
	    });
	}

	// ë­í‚¹ ì •ë³´ ì—…ë°ì´íŠ¸
	function updateRanking() {
	    $.ajax({
	        url: '/challenge/getRanking',
	        method: 'POST',
	        success: function(response) {
	            console.log('ë­í‚¹ ì‘ë‹µ:', response);
	            if (response.success && response.ranking) {
	                const rankCard = document.querySelector('.card.rank');
	                if (rankCard && response.ranking.length > 0) {
	                    let rankHTML = '<h3>ì ˆì•½ ë­í‚¹</h3>';
	                    
						const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰']; // 1-3ë“±ìš© ë©”ë‹¬

						response.ranking.forEach((user, index) => {
						    let displayText = '';
						    if (index < 3) {
						        displayText = `${medals[index]} ${user.NICKNAME}`;
						    } else {
						        displayText = `${index + 1}. ${user.NICKNAME}`; // 4ë“±ë¶€í„°ëŠ” ìˆ«ìë¡œ í‘œì‹œ
						    }
						    
						    rankHTML += `
						        <div class="rank-item">
						            <span>${displayText}</span>
						            <span>${user.TOTAL_POINT} í¬ì¸íŠ¸</span>
						        </div>
						    `;
						});
	                    
	                    rankCard.innerHTML = rankHTML;
	                } else {
	                    // ë­í‚¹ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
	                    const rankCard = document.querySelector('.card.rank');
	                    if (rankCard) {
	                        rankCard.innerHTML = `
	                            <h3>ì ˆì•½ ë­í‚¹</h3>
	                            <div style="text-align: center; color: #888; font-size: 0.9rem; padding: 20px 0;">
	                                ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
	                            </div>
	                        `;
	                    }
	                }
	            }
	        },
	        error: function(xhr, status, error) {
	            console.error('ë­í‚¹ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
	        }
	    });
	}
	// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
	window.onload = () => {
	    console.log('ë©”ì¸í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
	    updateMainPagePoints();
	    updateRanking(); // ë­í‚¹ ì •ë³´ë„ í•¨ê»˜ ë¡œë“œ
	};

	// í˜ì´ì§€ê°€ í¬ì»¤ìŠ¤ë¥¼ ë°›ì„ ë•Œë„ ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ëŒì•„ì™”ì„ ë•Œ)
	window.addEventListener('focus', () => {
	    console.log('í˜ì´ì§€ í¬ì»¤ìŠ¤ ë°›ìŒ - í¬ì¸íŠ¸ ë° ë­í‚¹ ì—…ë°ì´íŠ¸');
	    updateMainPagePoints();
	    updateRanking(); // ë­í‚¹ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
	});
</script>
<body>
	<!-- ì‚¬ì´ë“œë°” -->
	<div th:replace="common/sidebar :: sidebar"></div>
	
	<div class="main">
		<div class="grid">
			<div class="challenge"> <img src="/cards/ì ˆì•½ì±Œë¦°ì§€ë°°ë„ˆ(1).png" alt="ì ˆì•½ ì±Œë¦°ì§€ ì¹´ë“œ">
			</div>

			<div class="link"> <a th:href="@{challengeDetail}"> <img src="/cards/ë‚´ ì±Œë¦°ì§€.png"
					alt="ë‚´ ì±Œë¦°ì§€ ë³´ê¸°">
				</a>
			</div>

			<div class="card rank"> 
				<h3>ì ˆì•½ ë­í‚¹</h3>
				<!-- ê¸°ë³¸ í‘œì‹œ (JavaScriptë¡œ ë™ì  ì—…ë°ì´íŠ¸ë¨) -->
				<div class="rank-item">
					<span>ğŸ¥‡ ë¡œë”©ì¤‘...</span><span>- í¬ì¸íŠ¸</span>
				</div>
				<div class="rank-item">
					<span>ğŸ¥ˆ ë¡œë”©ì¤‘...</span><span>- í¬ì¸íŠ¸</span>
				</div>
				<div class="rank-item">
					<span>ğŸ¥‰ ë¡œë”©ì¤‘...</span><span>- í¬ì¸íŠ¸</span>
				</div>
			</div>

			<!-- í¬ì¸íŠ¸ ì¹´ë“œ (ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ í‘œì‹œ) -->
			<div class="card point">
			    <h3>ë‚´ í¬ì¸íŠ¸</h3>
			    <div th:if="${loginUser != null}" class="point-display">
			        <span class="highlight" th:text="${userPoints != null ? userPoints : 0}">0</span>
			        <span class="point-text">í¬ì¸íŠ¸</span>
			    </div>
			    <!-- ë¡œê·¸ì•„ì›ƒ ì‹œ í‘œì‹œ -->
			    <div th:if="${loginUser == null}" class="point-display">
			        <span style="font-size: 1rem; color: #888;">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
			    </div>
			</div>

			<div class="card badge"> <h3>ë‚´ ë±ƒì§€</h3>
				<div class="badge-item">
					<span>ğŸŒ±</span><span>ì ˆì•½ ìƒˆì‹¹</span>
				</div>
				<p style="font-size: 0.85rem; color: #777;">(ì•„ì´ì½˜)</p>
			</div>

			<div class="card tip">
				<h3>ì ˆì•½ TIP</h3>
				<div class="tip-content">
					<p>ğŸ’¡ ì–‘ì¹˜ì»µ ì‚¬ìš©í•˜ê¸°</p>
					<p>ğŸ”Œ í”ŒëŸ¬ê·¸ ë½‘ê¸°</p>
					<p>ğŸš¿ 5ë¶„ ìƒ¤ì›Œ ì‹¤ì²œ</p>
					<p>ğŸ’§ ì„¤ê±°ì§€ ë¬¼ ë°›ì•„ì„œ í•˜ê¸°</p>
				</div>
			</div>
		</div>
	</div>
	
	<!-- footer ì‹œì‘ -->
    <footer>
		<div>
			<p style="margin: 0;">Â© 2025 A.P.T. All rights reserved.</p>
			<p style="margin: 5px 0 0;">
				Made with <span class="computer-icon">ğŸ’»</span> by íŒ€ EF
			</p>
		</div>
	</footer>
	<!-- footer ë -->
</body>

</html>