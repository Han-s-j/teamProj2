<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>êµ¬ë… ì„¤ì • | A.P.T</title>

<link rel="stylesheet" th:href="@{/css/font.css}" />

<!-- Favicon -->
<link rel="icon" href="/icons/favicon.png" type="image/png">

<style>
body {
	margin: 0;
	padding: 0;
	font-family: 'Pretendard', sans-serif;
	background-color: #fdfdfd;
	overflow: hidden;
}

.container {
	width: 100%;
	margin: 0 0;
	background-color: #fff;
	padding: 40px 24px;
	box-sizing: border-box;
	text-align: center;
	min-height: 100vh;
}

.title-row {
	display: flex;
	align-items: center;
	gap: 8px;
	margin-bottom: 32px;
	display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 100px;
}

.title-row h2 {
	font-size: 30px;
	font-weight: 700;
	margin: 0;
	color: #292929;
}

.icon {
	width: 80px;
	height: 80px;
}

.btn {
	width: 300px;
	height: 100px;
	padding: 12px 0;
	margin: 10px auto;
	background-color: white;
	border: none;
	border-radius: 12px;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
	font-size: 22px;
	font-weight: 600;
	color: #292929;
	cursor: pointer;
	transition: all 0.2s ease;
}

.btn:hover {
	transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
    color: #61AFFE;
}

.footer-text {
	color: #919191;
	font-size: 20px;
	margin-top: 32px;
	letter-spacing: 0.8px;
}

.apt-logo {
	color: #3182f6;
	font-weight: 700;
	text-align: left;
	margin-bottom: 24px;
	font-size: 22px;
}
</style>
</head>
<body>
	<div class="container">
		<div class="apt-logo">A.P.T</div>
		<div class="title-row">
			<h2>A.P.Tí•‘ êµ¬ë… ì„¤ì •</h2>
			<img class="icon" src="/icons/ping_subsc.png" alt="ì•Œë¦¼ ì•„ì´ì½˜" />
		</div>
		<button class="btn">êµ¬ë…í•˜ê¸°</button>
		<br>
		<button class="btn">êµ¬ë… ì·¨ì†Œí•˜ê¸°</button>
		<p class="footer-text">
			êµ¬ë… ì„¤ì •ì´ ì™„ë£Œë˜ì–´ì•¼ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br> ì–¸ì œë“  ì·¨ì†Œí•  ìˆ˜ ìˆì–´ìš”!
		</p>
	</div>

	<script>
		// ì´ë¯¸ í‘œì‹œëœ ì•Œë¦¼ë“¤ì„ ì¶”ì í•˜ëŠ” Set
		let shownNotifications = new Set();
		// ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸í•œ ì•Œë¦¼ ê°œìˆ˜
		let lastNotificationCount = 0;
		// í˜ì´ì§€ ë¡œë“œ ì‹œì  ê¸°ë¡
		let pageLoadTime = Date.now();

		// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
		document.addEventListener('DOMContentLoaded', function() {
		    console.log('ğŸ”” êµ¬ë… ì„¤ì • í˜ì´ì§€ ë¡œë“œë¨');
		    
		    // êµ¬ë… ìƒíƒœ í™•ì¸
		    checkSubscriptionStatus();
		    
		    // ì´ˆê¸° ì•Œë¦¼ í™•ì¸ (ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨)
		    checkNewNotifications(false); // false = ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ ì•ˆ í•¨
		    
		    // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì—°ê²°
		    const buttons = document.querySelectorAll('.btn');
		    if (buttons.length >= 2) {
		        buttons[0].addEventListener('click', subscribeToPush);    // êµ¬ë…í•˜ê¸°
		        buttons[1].addEventListener('click', unsubscribeFromPush); // êµ¬ë… ì·¨ì†Œí•˜ê¸°
		    }
		    
		    // 30ì´ˆ í›„ë¶€í„° ì£¼ê¸°ì ìœ¼ë¡œ ìƒˆ ì•Œë¦¼ í™•ì¸ ì‹œì‘
		    setTimeout(() => {
		        console.log('ğŸ”„ ì£¼ê¸°ì  ì•Œë¦¼ í™•ì¸ ì‹œì‘');
		        setInterval(() => checkNewNotifications(true), 5000); // true = ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
		    }, 10000);
		});

		/**
		 * ìƒˆë¡œìš´ ì•Œë¦¼ í™•ì¸ í•¨ìˆ˜ (ë¹ˆ ì•Œë¦¼ ë°©ì§€ ë¡œì§ ì¶”ê°€)
		 */
		 async function checkNewNotifications(showBrowserNotification = true) {
		     try {
		         console.log('ğŸ” ìƒˆë¡œìš´ ì•Œë¦¼ í™•ì¸ ì¤‘... (ë¸Œë¼ìš°ì € ì•Œë¦¼:', showBrowserNotification, ')');
		         
		         const response = await fetch('/api/notifications/recent');
		         if (response.ok) {
		             const data = await response.json();
		             
		             if (data.success) {
		                 console.log('ğŸ“Š ì•Œë¦¼ í™•ì¸ ê²°ê³¼:', data);
		                 console.log('ğŸ“‹ ë°›ì€ ì•Œë¦¼ ë°ì´í„° êµ¬ì¡° í™•ì¸:', data.notifications.length > 0 ? data.notifications[0] : 'ì•Œë¦¼ ì—†ìŒ');
		                 
		                 updateNotificationBadge(data.unreadCount);
		                 
		                 if (showBrowserNotification && data.notifications && data.notifications.length > 0) {
		                     
		                     const timeSinceLoad = Date.now() - pageLoadTime;
		                     if (timeSinceLoad < 10000) {
		                         console.log('â° í˜ì´ì§€ ë¡œë“œ í›„ 10ì´ˆ ë¯¸ë§Œìœ¼ë¡œ, ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
		                         return data;
		                     }
		                     
		                     // ğŸ”§ ìˆ˜ì •ëœ ë¶€ë¶„: ì˜¬ë°”ë¥¸ í•„ë“œëª… ì‚¬ìš©
		                     const newNotifications = data.notifications.filter(notification => {
		                         // Javaì—ì„œ ë³´ë‚´ëŠ” ì‹¤ì œ í•„ë“œëª…ë“¤ í™•ì¸
		                         const notificationId = notification.notification_id || 
		                                              notification.NOTIFICATION_ID ||
		                                              notification.HISTORY_ID ||
		                                              notification.history_id ||
		                                              `${notification.SENDER_ID}_${Date.now()}`;
		                         
		                         console.log('ğŸ” ì•Œë¦¼ ID í™•ì¸:', notificationId, 'ì´ë¯¸ í‘œì‹œë¨:', shownNotifications.has(notificationId));
		                         
		                         return notificationId && !shownNotifications.has(notificationId);
		                     });
		                     
		                     console.log(`ğŸ“¢ ìƒˆë¡œìš´ ì•Œë¦¼: ${newNotifications.length}ê°œ / ì „ì²´: ${data.notifications.length}ê°œ`);
		                     console.log('ğŸ“‹ ìƒˆ ì•Œë¦¼ ìƒì„¸:', newNotifications);
		                     
		                     // ğŸ”§ ìˆ˜ì •ëœ ë¶€ë¶„: ê° ì•Œë¦¼ ì²˜ë¦¬
		                     newNotifications.forEach(notification => {
		                         const message = notification.message || 
		                                       notification.NOTI_CONTENT || 
		                                       notification.MESSAGE ||
		                                       'ìƒˆë¡œìš´ ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.';
		                         
		                         console.log('ğŸ“ ì²˜ë¦¬í•  ë©”ì‹œì§€:', message);
		                         
		                         if (message && message.trim()) {
		                             console.log('ğŸ”” ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ ì‹œë„:', message);
		                             showNotificationPopup(notification);
		                             
		                             // í‘œì‹œëœ ì•Œë¦¼ì„ Setì— ì¶”ê°€
		                             const notificationId = notification.notification_id || 
		                                                  notification.NOTIFICATION_ID ||
		                                                  notification.HISTORY_ID ||
		                                                  notification.history_id ||
		                                                  `${notification.SENDER_ID}_${Date.now()}`;
		                             
		                             shownNotifications.add(notificationId);
		                             console.log('âœ… ì•Œë¦¼ ID ì €ì¥ë¨:', notificationId);
		                         } else {
		                             console.log('âš ï¸ ë¹ˆ ë©”ì‹œì§€ ì•Œë¦¼ ë¬´ì‹œ:', notification);
		                         }
		                     });
		                 }
		                 
		                 return data;
		             } else {
		                 console.warn('âš ï¸ ì•Œë¦¼ í™•ì¸ ì‹¤íŒ¨:', data.message);
		             }
		         } else {
		             console.error('âŒ ì•Œë¦¼ í™•ì¸ API ì˜¤ë¥˜:', response.status);
		         }
		     } catch (error) {
		         console.log('ì•Œë¦¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ):', error);
		     }
		     
		     return { notifications: [], unreadCount: 0 };
		 }
		/**
		 * ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
		 */
		function updateNotificationBadge(unreadCount) {
		    // ì•Œë¦¼ ë°°ì§€ ìš”ì†Œê°€ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
		    const badge = document.querySelector('.notification-badge');
		    if (badge) {
		        if (unreadCount > 0) {
		            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
		            badge.style.display = 'block';
		        } else {
		            badge.style.display = 'none';
		        }
		    }
		    
		    // í˜ì´ì§€ ì œëª©ì— ì•Œë¦¼ ê°œìˆ˜ í‘œì‹œ (ì„ íƒì‚¬í•­)
		    if (unreadCount > 0) {
		        document.title = `(${unreadCount}) êµ¬ë… ì„¤ì • | A.P.T`;
		    } else {
		        document.title = 'êµ¬ë… ì„¤ì • | A.P.T';
		    }
		    
		    console.log(`ğŸ”” ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸: ${unreadCount}ê°œ`);
		}

		// ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ (ê°œì„ ë¨ - ë¹ˆ ì•Œë¦¼ ë°©ì§€)
		function showNotificationPopup(notificationData) {
		    console.log('ğŸš€ showNotificationPopup í˜¸ì¶œë¨:', notificationData);
		    
		    // ğŸ”§ ì•Œë¦¼ ê¶Œí•œ ë‹¤ì‹œ í™•ì¸
		    if (!('Notification' in window)) {
		        console.log('âŒ ë¸Œë¼ìš°ì €ê°€ Notification APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ');
		        return;
		    }
		    
		    if (Notification.permission !== 'granted') {
		        console.log('âŒ ì•Œë¦¼ ê¶Œí•œì´ ì—†ìŒ. í˜„ì¬ ê¶Œí•œ:', Notification.permission);
		        
		        // ê¶Œí•œ ì¬ìš”ì²­
		        Notification.requestPermission().then(permission => {
		            console.log('ğŸ”” ê¶Œí•œ ì¬ìš”ì²­ ê²°ê³¼:', permission);
		            if (permission === 'granted') {
		                showNotificationPopup(notificationData); // ì¬ê·€ í˜¸ì¶œ
		            }
		        });
		        return;
		    }
		    
		    try {
		        const message = notificationData.message || 
		                       notificationData.NOTI_CONTENT || 
		                       notificationData.MESSAGE ||
		                       'ìƒˆë¡œìš´ ì•Œë¦¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤.';
		        
		        const senderId = notificationData.SENDER_ID || 
		                        notificationData.sender_id || 
		                        'ì•Œë¦¼';
		        
		        // ë©”ì‹œì§€ê°€ ì™„ì „íˆ ë¹„ì–´ìˆê±°ë‚˜ ê³µë°±ë§Œ ìˆìœ¼ë©´ í‘œì‹œ ì•ˆ í•¨
		        if (!message || !message.trim()) {
		            console.log('ğŸ“­ ë¹ˆ ë©”ì‹œì§€ ì•Œë¦¼ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ');
		            return;
		        }
		        
		        const notificationId = notificationData.notification_id || 
		                             notificationData.NOTIFICATION_ID ||
		                             notificationData.HISTORY_ID ||
		                             notificationData.history_id ||
		                             Date.now();
		        
		        console.log('ğŸ”” ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ ì‹œì‘:', {
		            id: notificationId,
		            message: message,
		            sender: senderId
		        });
		        
		        const notification = new Notification('ğŸ  A.P.T ì»¤ë®¤ë‹ˆí‹° ì•Œë¦¼', {
		            body: `${senderId}ë‹˜: ${message}`,
		            icon: '/icons/favicon.png',
		            badge: '/icons/favicon.png',
		            tag: 'apt-notification-' + notificationId,
		            requireInteraction: false,
		            silent: false,
		            timestamp: Date.now()
		        });
		        
		        console.log('âœ… ë¸Œë¼ìš°ì € ì•Œë¦¼ ìƒì„± ì„±ê³µ!');
		        
		        notification.onclick = function() {
		            console.log('ğŸ–±ï¸ ì•Œë¦¼ í´ë¦­ë¨');
		            window.focus();
		            notification.close();
		        };
		        
		        notification.onshow = function() {
		            console.log('ğŸ‘ï¸ ì•Œë¦¼ì´ í™”ë©´ì— í‘œì‹œë¨');
		        };
		        
		        notification.onerror = function(error) {
		            console.error('âŒ ì•Œë¦¼ í‘œì‹œ ì˜¤ë¥˜:', error);
		        };
		        
		        // 8ì´ˆ í›„ ìë™ ë‹«ê¸°
		        setTimeout(() => {
		            notification.close();
		            console.log('â° ì•Œë¦¼ ìë™ ë‹«ê¸°');
		        }, 8000);
		        
		    } catch (error) {
		        console.error('âŒ ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ ì‹¤íŒ¨:', error);
		    }
		}

		// êµ¬ë… ìƒíƒœ í™•ì¸
		async function checkSubscriptionStatus() {
		    try {
		        console.log('ğŸ” êµ¬ë… ìƒíƒœ í™•ì¸ ì¤‘...');
		        
		        const response = await fetch('/api/notifications/subscription/status');
		        const result = await response.json();
		        
		        console.log('ğŸ“Š êµ¬ë… ìƒíƒœ ì‘ë‹µ:', result);
		        
		        if (response.ok && result.success) {
		            updateButtonStyles(result.isSubscribed);
		        } else {
		            console.error('êµ¬ë… ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', result.message);
		            updateFooterText('êµ¬ë… ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
		        }

		    } catch (error) {
		        console.error('êµ¬ë… ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
		        updateFooterText('êµ¬ë… ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
		    }
		}

		// ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (í…ìŠ¤íŠ¸ë§Œ ë³€ê²½, ìŠ¤íƒ€ì¼ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
		function updateButtonStyles(isSubscribed) {
		    const subscribeBtn = document.querySelectorAll('.btn')[0];
		    const unsubscribeBtn = document.querySelectorAll('.btn')[1];
		    
		    console.log('ğŸ¨ UI ì—…ë°ì´íŠ¸ - êµ¬ë… ìƒíƒœ:', isSubscribed);
		    
		    if (isSubscribed) {
		        // êµ¬ë… ì¤‘ì¼ ë•Œ - í…ìŠ¤íŠ¸ë§Œ ë³€ê²½
		        subscribeBtn.textContent = 'âœ… êµ¬ë… ì¤‘';
		        unsubscribeBtn.textContent = 'êµ¬ë… ì·¨ì†Œí•˜ê¸°';
		        
		        updateFooterText('ğŸ”” ì•Œë¦¼ êµ¬ë… ì¤‘ì…ë‹ˆë‹¤!<br>ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ë„¤ ì†Œì‹ì„ ë°›ì•„ë³´ì„¸ìš”.');
		    } else {
		        // ë¯¸êµ¬ë…ì¼ ë•Œ - í…ìŠ¤íŠ¸ë§Œ ë³€ê²½
		        subscribeBtn.textContent = 'êµ¬ë…í•˜ê¸°';
		        unsubscribeBtn.textContent = 'êµ¬ë… ì·¨ì†Œí•˜ê¸°';
		        
		        updateFooterText('êµ¬ë… ì„¤ì •ì´ ì™„ë£Œë˜ì–´ì•¼ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ì–¸ì œë“  ì·¨ì†Œí•  ìˆ˜ ìˆì–´ìš”!');
		    }
		}

		// í‘¸í„° í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
		function updateFooterText(text) {
		    const footerText = document.querySelector('.footer-text');
		    if (footerText) {
		        footerText.innerHTML = text;
		    }
		}
		// âœ… Web Push êµ¬ë… í•¨ìˆ˜
		async function subscribeToPush() {
		    console.log('ğŸ”” Web Push êµ¬ë… ì‹œì‘...');

		    try {
		        // 1. ë¸Œë¼ìš°ì € ì§€ì› ì—¬ë¶€
		        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
		            alert('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
		            return;
		        }

		        // 2. ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
		        const permission = await Notification.requestPermission();
		        console.log('ğŸ”‘ ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:', permission);
		        if (permission !== 'granted') {
		            alert('âŒ ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì•Œë¦¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
		            return;
		        }

		        // 3. Service Worker ë“±ë¡
		        let registration;
		        try {
		            registration = await navigator.serviceWorker.register('/sw.js');
		            console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', registration);
		            await navigator.serviceWorker.ready;
		        } catch (error) {
		            console.error('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
		            alert('âŒ Service Worker ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		            return;
		        }

		        // 4. VAPID Key ë³€í™˜ í™•ì¸
		        const vapidPublicKey = 'BMxQ-_IgmKJ6Qwj5Fw6p3VSeqlNsCJ5H8RQZ8l2n6zLh_XYQ8sZPp7Yk7q_nW8kJGzN4x3c_ZJ3z2p7mQ8k5L4o';
		        const applicationServerKey = urlBase64ToUint8Array(vapidPublicKey);
		        console.log('ğŸ”‘ VAPID Key ë³€í™˜ ì™„ë£Œ:', applicationServerKey);

		        // 5. í‘¸ì‹œ êµ¬ë…
		        let subscription;
		        try {
		            subscription = await registration.pushManager.subscribe({
		                userVisibleOnly: true,
		                applicationServerKey: applicationServerKey
		            });
		            console.log('âœ… í‘¸ì‹œ êµ¬ë… ìƒì„± ì„±ê³µ:', subscription);
		        } catch (error) {
		            console.error('âŒ í‘¸ì‹œ êµ¬ë… ìƒì„± ì‹¤íŒ¨:', error);
		            alert('âŒ í‘¸ì‹œ êµ¬ë… ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n' + error.message);
		            return;
		        }

		        // 6. ì„œë²„ë¡œ êµ¬ë… ì •ë³´ ì „ì†¡
		        const subscriptionData = {
		            notiType: "ì»¤ë®¤ë‹ˆí‹°",
		            guideTime: "ì‹¤ì‹œê°„",
		            browserSupport: true,
		            permission: permission,
		            subscription: subscription,
		            endpoint: subscription.endpoint,
		            keys: {
		                p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
		                auth: arrayBufferToBase64(subscription.getKey('auth'))
		            }
		        };

		        console.log('ğŸ“¤ ì„œë²„ì— ë³´ë‚¼ êµ¬ë… ë°ì´í„°:', subscriptionData);

		        const response = await fetch('/api/notifications/subscribe', {
		            method: 'POST',
		            headers: { 'Content-Type': 'application/json' },
		            body: JSON.stringify(subscriptionData)
		        });

		        const result = await response.json();
		        console.log('ğŸ“¥ ì„œë²„ ì‘ë‹µ:', result);

		        if (response.ok && result.success) {
		            console.log('âœ… êµ¬ë… ì„œë²„ ë“±ë¡ ì„±ê³µ:', result);
		            alert('ğŸ‰ í‘¸ì‹œ ì•Œë¦¼ êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');

		            updateButtonStyles(true);
		            checkSubscriptionStatus();
		            shownNotifications.clear();
		            pageLoadTime = Date.now();
		            setTimeout(() => checkNewNotifications(false), 1000);

		            if (registration.showNotification) {
		                registration.showNotification('A.P.T ì•Œë¦¼', {
		                    body: 'êµ¬ë…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ë™ë„¤ ì†Œì‹ì„ ë°›ì•„ë³´ì„¸ìš”.',
		                    icon: '/icons/favicon.png',
		                    tag: 'subscription-success'
		                });
		            }

		        } else {
		            throw new Error(result.message || 'ì„œë²„ êµ¬ë… ë“±ë¡ ì‹¤íŒ¨');
		        }

		    } catch (error) {
		        console.error('âŒ ìµœì¢… êµ¬ë… í”„ë¡œì„¸ìŠ¤ ì¤‘ ì˜¤ë¥˜:', error);
		        alert('âŒ êµ¬ë… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
		    }
		}
		
		// PWA êµ¬ë… ì·¨ì†Œ í•¨ìˆ˜
		async function unsubscribeFromPush() {
		    try {
		        console.log('ğŸš« êµ¬ë… ì·¨ì†Œ ìš”ì²­ ì‹œì‘...');

		        const response = await fetch('/api/notifications/unsubscribe', {
		            method: 'POST',
		            headers: {
		                'Content-Type': 'application/json',
		            }
		        });

		        const result = await response.json();
		        console.log('ğŸ“¥ êµ¬ë… ì·¨ì†Œ ì‘ë‹µ:', result);

		        if (response.ok && result.success) {
		            alert('âœ… êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\në” ì´ìƒ ì•Œë¦¼ì„ ë°›ì§€ ì•ŠìŠµë‹ˆë‹¤.');
		            updateButtonStyles(false);
		            checkSubscriptionStatus();
		            
		            // í‘œì‹œëœ ì•Œë¦¼ ê¸°ë¡ ì´ˆê¸°í™”
		            shownNotifications.clear();
		            
		        } else {
		            throw new Error(result.message || 'ì„œë²„ êµ¬ë… ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨');
		        }
		        
		    } catch (error) {
		        console.error('êµ¬ë… ì·¨ì†Œ ì˜¤ë¥˜:', error);
		        alert('âŒ êµ¬ë… ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message);
		    }
		}

		// VAPID ê³µê°œ í‚¤ë¥¼ Uint8Arrayë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
		function urlBase64ToUint8Array(base64String) {
		    const padding = '='.repeat((4 - base64String.length % 4) % 4);
		    const base64 = (base64String + padding)
		        .replace(/\-/g, '+')
		        .replace(/_/g, '/');
		    
		    const rawData = window.atob(base64);
		    const outputArray = new Uint8Array(rawData.length);
		    
		    for (let i = 0; i < rawData.length; ++i) {
		        outputArray[i] = rawData.charCodeAt(i);
		    }
		    return outputArray;
		}

		// ArrayBufferë¥¼ Base64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
		function arrayBufferToBase64(buffer) {
		    const bytes = new Uint8Array(buffer);
		    let binary = '';
		    for (let i = 0; i < bytes.byteLength; i++) {
		        binary += String.fromCharCode(bytes[i]);
		    }
		    return window.btoa(binary);
		}

		/**
		 * ì•Œë¦¼ ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
		 */
		function formatNotificationTime(timeString) {
		    try {
		        const date = new Date(timeString);
		        const now = new Date();
		        const diffMs = now - date;
		        const diffMins = Math.floor(diffMs / 60000);
		        const diffHours = Math.floor(diffMins / 60);
		        const diffDays = Math.floor(diffHours / 24);
		        
		        if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
		        if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
		        if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
		        if (diffDays < 7) return `${diffDays}ì¼ ì „`;
		        
		        return date.toLocaleDateString('ko-KR');
		    } catch (error) {
		        return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
		    }
		}
	</script>
</body>
</html>