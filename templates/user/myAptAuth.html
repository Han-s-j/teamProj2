<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì•„íŒŒíŠ¸ ì¸ì¦ | A.P.T</title>

<!-- ì‚¬ì´ë“œë°” css -->
<link rel="stylesheet" href="/css/sidebar.css">

<!-- Pretendard(Font) -->
<link rel="stylesheet" th:href="@{/css/font.css}" />

<!-- Favicon -->
<link rel="icon" href="/icons/favicon.png" type="image/png">

<style>
/* ì „ì²´ í˜ì´ì§€ ë ˆì´ì•„ì›ƒì„ ìœ„í•œ flexbox ì„¤ì • */
body {
	display: flex;
	flex-direction: column;
	min-height: 100vh; /* ë·°í¬íŠ¸ ë†’ì´ì˜ 100%ë¥¼ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
	margin: 0;
	font-family: 'Pretendard', sans-serif; /* í°íŠ¸ ì ìš© */
	background-color: #fdfdfd;
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ (ê°„ë‹¨ ì˜ˆì‹œ) */
.spinner {
	border: 4px solid rgba(0, 0, 0, 0.1);
	width: 36px;
	height: 36px;
	border-radius: 50%;
	border-left-color: #09f;
	animation: spin 1s ease infinite;
	display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
	position: absolute;
	top: 60%; /* ë¶€ëª¨ ê¸°ì¤€ìœ¼ë¡œ ì„¸ë¡œ ì¤‘ì•™ */
    left: 49%; /* ë¶€ëª¨ ê¸°ì¤€ìœ¼ë¡œ ê°€ë¡œ ì¤‘ì•™ */
    transform: translate(-50%, -50%);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* container divë¥¼ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡ í•˜ëŠ” ìŠ¤íƒ€ì¼ */
.container {
	flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì •í•˜ì—¬ í‘¸í„°ë¥¼ ì•„ë˜ë¡œ ë°€ì–´ëƒ„ */
	display: flex;
	flex-direction: column;
	justify-content: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
	align-items: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
	padding: 20px; /* ë‚´ë¶€ ì—¬ë°± ì¶”ê°€ */
	box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ ì„¤ì • */
	position: relative;
}

/* h1 íƒœê·¸ì˜ ê¸°ë³¸ margin ì œê±° */
.container h1 {
	margin-top: 0;
	margin-bottom: 0;
	color: #292929;
	font-size: 36px;
}

.container p {
	color: #919191;
	font-size: 18px;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
#uploadBtn {
	padding: 10px 20px;
	background-color: #4281FF;
	color: white;
	border: none;
	border-radius: 20px;
	cursor: pointer;
	font-size: 18px;
	font-weight: 600;
	margin-bottom: 15px;
    transition: all 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ë¥¼ ìœ„í•´ ì¶”ê°€ */
    font-family: 'Pretendard', sans-serif;
    position: relative; /* íˆ´íŒ ìœ„ì¹˜ ê¸°ì¤€ */
}

#uploadBtn:hover {
	/* background-color: #0056b3; */ /* ë°°ê²½ìƒ‰ ë³€ê²½ì€ ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì‚­ì œ */
    transform: translateY(-3px); /* ë²„íŠ¼ì„ ìœ„ë¡œ ì‚´ì§ ì´ë™ */
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* ê·¸ë¦¼ì íš¨ê³¼ ì¶”ê°€ */
}

/* OCR ê²°ê³¼ì™€ ì´ë¯¸ì§€ë¥¼ ê°€ë¡œ ì •ë ¬í•˜ê¸° ìœ„í•œ ì»¨í…Œì´ë„ˆ */
.ocr-results-wrapper {
    display: flex;
    justify-content: center; /* ë‚´ë¶€ ìš”ì†Œ ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
    align-items: flex-start; /* ì„¸ë¡œ ìƒë‹¨ ì •ë ¬ */
    width: 100%; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ë„ˆë¹„ 100% ì‚¬ìš© */
    flex-wrap: wrap; /* í™”ë©´ì´ ì‘ì•„ì§€ë©´ ìë™ìœ¼ë¡œ ì¤„ë°”ê¿ˆ */
    gap: 30px;
}

#ocrResultDisplay {
	display: none; /* OCR ê²°ê³¼ê°€ ì—†ì„ ë•ŒëŠ” ìˆ¨ê¹€ */
	padding: 15px;
	margin-top: 20px;
	background-color: #fdfdfd;
	border-radius: 20px;
	box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
	min-width: 300px; /* í˜„ì¬ ì„¤ì •ëœ ìµœì†Œ ë„ˆë¹„ */
    max-width: 400px; /* ì›í•˜ëŠ” ìµœëŒ€ ë„ˆë¹„ë¡œ ì„¤ì • (ì˜ˆ: 400px) */
    min-height: 400px;
    color: #292929;
}

#ocrResultDisplay h3 {
	font-size: 30px;
	text-align: center;
}

#ocrResultDisplay p {
	font-size: 16px;
	text-align: center;
	margin-top: 70px;
	margin-bottom: 0;
}

#ocrResultDisplay ul {
    list-style-type: none; /* ê¸°ë³¸ ì (bullet) ì—†ì• ê¸° */
    padding-left: 0; /* ulì˜ ê¸°ë³¸ ì™¼ìª½ íŒ¨ë”© ì œê±° */
    margin-top: 0;
}

#ocrResultDisplay li {
	font-size: 20px;
	font-weight: 600;
}

#ocrResultDisplay ul li {
    position: relative; /* ê°€ìƒ ìš”ì†Œë¥¼ ìœ„í•œ ìœ„ì¹˜ ê¸°ì¤€ ì„¤ì • */
    padding-left: 40px; /* ìƒˆë¡œìš´ ì‹¬ë³¼ ê³µê°„ í™•ë³´ */
    margin-bottom: 10px; /* li í•­ëª© ê°„ ê°„ê²© ì¡°ì • */
}

#ocrResultDisplay ul li::before {
    content: "ğŸ‘‰"; /* ì›í•˜ëŠ” ìœ ë‹ˆì½”ë“œ ì‹¬ë³¼ì´ë‚˜ ë¬¸ìì—´ */
    /* content: "âœ”"; */
    /* content: "â€¢"; */ /* ë‹¤ë¥¸ ì  ëª¨ì–‘ë„ ê°€ëŠ¥ */
    position: absolute;
    left: 0; /* liì˜ ì‹œì‘ ì§€ì ì— ìœ„ì¹˜ */
}

#confirmBtn {
	margin-top: 50px;
	padding: 10px 20px;
	background-color: #fff;
	color: #4281FF;
	border: 1px solid #4281FF;
	border-radius: 20px;
	cursor: pointer;
	font-size: 16px;
	display: block; /* ë¸”ë¡ ë ˆë²¨ ìš”ì†Œë¡œ ë³€ê²½í•˜ì—¬ margin: autoê°€ ì‘ë™í•˜ë„ë¡ í•©ë‹ˆë‹¤. */
    width: fit-content; /* ë²„íŠ¼ ë‚´ìš©ì— ë§ì¶° ë„ˆë¹„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤. */
    /* width: 200px; ë“±ìœ¼ë¡œ ê³ ì • ë„ˆë¹„ë¥¼ ì§€ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. */
    margin-left: auto; /* ì™¼ìª½ ë§ˆì§„ì„ ìë™ìœ¼ë¡œ ì„¤ì • */
    margin-right: auto; /* ì˜¤ë¥¸ìª½ ë§ˆì§„ì„ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ê°€ìš´ë° ì •ë ¬ */
    transition: all 0.3s ease;
}

#confirmBtn:hover {
	background-color: #4281FF;
	color: #fff;
}

#ocrImage {
    display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    width: 550px;
    max-width: 100%; /* ë¶€ëª¨ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì ˆ */
    height: auto; /* ë¹„ìœ¨ ìœ ì§€ */
    border: 1px solid #ddd;
    border-radius: 20px;
    margin-left: 20px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

/* ocrResultDisplay ulì˜ ê¸°ë³¸ íŒ¨ë”©/ë§ˆì§„ ì œê±° */
#ocrResultDisplay ul {
    padding-left: 20px;
    margin-top: 0;
}

/* ì„¤ëª… íˆ´íŒ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.tooltip-message {
  position: absolute;
  top: 100%;
  left: -85%;
  transform: translateY(40%);
  background-color: #333;
  color: #fff;
  font-size: 15px;
  padding: 8px 12px;
  border-radius: 8px;
  white-space: nowrap;
  z-index: 10;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.tooltip-message::before {
  content: "";
  position: absolute;
  top: -11px;
  left: 50%;
  transform: translateX(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: transparent transparent #333 transparent;
}

/* hover ì‹œ ë³´ì´ê²Œ */
#uploadBtn:hover .tooltip-message {
  opacity: 1;
}

footer {
	background-color: #f2f2f2;
	padding: 15px 0;
	text-align: center;
	font-size: 14px;
	color: #666;
	width: 100%;
	flex-shrink: 0; /* í‘¸í„°ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
}
</style>

</head>
<body>
	<!-- ì‚¬ì´ë“œë°” í¬í•¨ -->
	<div th:replace="common/sidebar :: sidebar"></div>

	<div class="container">
		<h1>ì•„íŒŒíŠ¸ ì¸ì¦</h1>
		<p>ê´€ë¦¬ë¹„ ê³ ì§€ì„œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  <b>A.P.T</b>ì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.</p>
		
		<form id="uploadForm">
			<input type="file" name="file" id="fileInput" style="display: none;"
				accept="image/*" />
			<button type="button" id="uploadBtn">ğŸ“¤ ì—…ë¡œë“œ
			<div class="tooltip-message">ê´€ë¦¬ë¹„ ë‚©ì…ì˜ìˆ˜ì¦ (ì…ì£¼ììš©)ì´ ë³´ì´ê²Œ ì°ì–´ì£¼ì„¸ìš”.</div>
			</button>
			
		</form>

		<p id="error" style="color: red;"></p>

		<!-- ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ -->
		<div class="spinner" id="loadingSpinner"></div>
		
		<!-- ì¸ì‹ ê²°ê³¼ê°€ ë‚˜ì˜¤ëŠ” ë¶€ë¶„ -->
		<div class="ocr-results-wrapper">
		
			<img id="ocrImage">
		
			<div id="ocrResultDisplay">
				<h3>ì¸ì‹ëœ ì •ë³´</h3>
				<ul>
					<li>ì•„íŒŒíŠ¸ ì´ë¦„: <span id="aptName"></span></li>
					<li><span id="dong"></span> ë™</li>
					<li><span id="ho"></span> í˜¸</li>
					<li style="display: none;">ê´€ë¦¬ì†Œì „í™”ë²ˆí˜¸: <span id="callNum"></span></li>
					<li style="display: none;">KaptCode: <span id="kaptCodeHidden"></span></li>
				</ul>
				<p>ìœ„ ì •ë³´ê°€ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!</p>
				<button type="button" id="confirmBtn">ì´ ì •ë³´ë¡œ ì¸ì¦í•˜ê¸°</button>
			</div>
		</div>

	</div>

	<!-- footer ì‹œì‘ -->
	<footer>
		<div>
			<p style="margin: 0;">Â© 2025 A.P.T. All rights reserved.</p>
			<p style="margin: 5px 0 0;">
				Made with <span class="computer-icon">ğŸ’»</span> by íŒ€ EF
			</p>
		</div>
	</footer>
	<!-- footer ë -->

	<script>
	// ì „ì—­ ë³€ìˆ˜ë¡œ OCR ê²°ê³¼ë¥¼ ì €ì¥ (í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì‚¬ìš©)
    let ocrDataForConfirmation = null;
	
	document.getElementById("uploadBtn").addEventListener("click", () => {
		  document.getElementById("fileInput").click();  // íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
		});

		document.getElementById("fileInput").addEventListener("change", async (event) => {
		  const file = event.target.files[0];
		  if (!file) return;

		  const formData = new FormData();
		  formData.append("file", file);

		  const errorEl = document.getElementById("error");
		  const loadingSpinner = document.getElementById("loadingSpinner");
		  const ocrResultDisplay = document.getElementById("ocrResultDisplay");
		  const confirmBtn = document.getElementById("confirmBtn");
		  
		  errorEl.textContent = "";
	  	  ocrResultDisplay.style.display = "none"; // ì´ì „ ê²°ê³¼ ìˆ¨ê¹€
      	  confirmBtn.style.display = "none"; // í™•ì¸ ë²„íŠ¼ ìˆ¨ê¹€
	  	  document.getElementById("ocrImage").style.display = "none"; // ì´ë¯¸ì§€ ìˆ¨ê¹€
      	  loadingSpinner.style.display = "block"; // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ

		  try {
			// Spring Boot ì„œë²„ì˜ OCR ì²˜ë¦¬ ì—”ë“œí¬ì¸íŠ¸ë¡œ ìš”ì²­ (DB ì €ì¥ ì—†ìŒ)
		    const res = await fetch("/aptAuthProcess", {
		      method: "POST",
		      body: formData
		    });
			
		    loadingSpinner.style.display = "none"; // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€

		    if (!res.ok) {
		      const errData = await res.json();
		      errorEl.textContent = errData.error || "ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
		      return;
		    }

		    const data = await res.json();
		 	// Spring Boot ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë³´ë‚¸ JSON ì‘ë‹µ êµ¬ì¡°ì— ë§ì¶° ë°ì´í„°ë¥¼ íŒŒì‹±
		    const resultText = data.message; // OCR ê²°ê³¼ (ë™, í˜¸, ì „í™”ë²ˆí˜¸)
		    const aptName = data.aptName;
		    const kaptCode = data.kaptCode;
		    const imageBase64 = data.image;	// ì¸ì‹ëœ ê³ ì§€ì„œ ì´ë¯¸ì§€
		 	// í™”ë©´ì— ì¸ì‹ëœ ì •ë³´ í‘œì‹œ
		    document.getElementById("dong").textContent = resultText.dong_result || "ì—†ìŒ";
		    document.getElementById("ho").textContent = resultText.ho_result || "ì—†ìŒ";
            document.getElementById("aptName").textContent = aptName || "ì •ë³´ ì—†ìŒ"; // ì•„íŒŒíŠ¸ëª… í‘œì‹œ
		    document.getElementById("callNum").textContent = resultText.number_result || "ì—†ìŒ";
            document.getElementById("kaptCodeHidden").textContent = kaptCode || ""; // KaptCode ìˆ¨ê²¨ì„œ ì €ì¥

            // OCR ê²°ê³¼ í‘œì‹œ ì˜ì—­ ë³´ì´ê²Œ í•¨
             ocrResultDisplay.style.display = "block";
             confirmBtn.style.display = "block"; // í™•ì¸ ë²„íŠ¼ ë³´ì´ê²Œ í•¨
             
          	// í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ DB ì €ì¥ì— ì‚¬ìš©ë  ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
             ocrDataForConfirmation = {
                 dong: resultText.dong_result,
                 ho: resultText.ho_result,
                 callNum: resultText.number_result,
                 kaptCode: kaptCode
             };
             
			    const imgTag = document.getElementById("ocrImage");
			    imgTag.src = "data:image/png;base64," + imageBase64;
			    imgTag.style.display = "block";

			  } catch (err) {
			    loadingSpinner.style.display = "none"; // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
			    errorEl.textContent = "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
			    console.error(err);
			  }
			});
		// 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
		document.getElementById("confirmBtn").addEventListener("click", async () => {
        if (!ocrDataForConfirmation) {
            document.getElementById("error").textContent = "ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            return;
        }

        const confirmBtn = document.getElementById("confirmBtn");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const errorEl = document.getElementById("error");

        confirmBtn.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”
        loadingSpinner.style.display = "block"; // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
        errorEl.textContent = "";

        try {
            // 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ DB ì €ì¥ ìš”ì²­ì„ ë³´ë‚¼ ìƒˆë¡œìš´ ì—”ë“œí¬ì¸íŠ¸
            const res = await fetch("/saveAptAuthInfo", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json" // JSON í˜•íƒœë¡œ ë°ì´í„° ì „ì†¡
                },
                body: JSON.stringify(ocrDataForConfirmation) // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ëœ ë°ì´í„° ì „ì†¡
            });

            loadingSpinner.style.display = "none"; // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
            confirmBtn.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”

            if (!res.ok) {
                const errData = await res.json();
                errorEl.textContent = errData.error || "ì¸ì¦ ì •ë³´ ì €ì¥ ì‹¤íŒ¨.";
                return;
            }

            const successData = await res.json();
            alert(successData.message || "ì•„íŒŒíŠ¸ ì¸ì¦ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.location.href = "/mypage"; // ì¸ì¦ ì„±ê³µ í›„ í™ˆìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™

        } catch (err) {
            loadingSpinner.style.display = "none"; // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
            confirmBtn.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            errorEl.textContent = "ì¸ì¦ ì •ë³´ ì €ì¥ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
            console.error(err);
        }
    });
		
    </script>
</body>
</html>